name: CI

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./cicd-learning/ci-simulation
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run lint
        run: ./lint.sh

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [ lint ]
    defaults:
      run:
        working-directory: ./cicd-learning/ci-simulation
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install zip
        run: |
          sudo apt-get update
          sudo apt-get install -y zip

      - name: Run build
        run: ./build.sh

      - name: Clean old artifacts
        run: rm -rf ci-artifacts

      - name: package build artifact
        run: ./package.sh

      - name: upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ./cicd-learning/ci-simulation/ci-artifacts/*.zip
          if-no-files-found: error

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [ build ]
    defaults:
      run:
        working-directory: ./cicd-learning/ci-simulation
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set executable permissions
        run: chmod +x ./*.sh

      - name: Run tests
        run: ./test.sh

      - name: Upload logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: ./cicd-learning/ci-simulation/*.log
          if-no-file-found: warn

  deploy-sim:
     name: Deploy Simulation (Consume Artifact)
     runs-on: ubuntu-latest
     needs: [ build, test ]
     steps:
       - name: Workspace before download
         run: |
          pwd
          echo "Listing workspace:"
          ls -la

       - name: Download build artifact
         uses: actions/download-artifact@v4
         with:
           name: build-artifact
           path: download-artifact

       - name: Workspace after download
         run: |
          set -e
          pwd
          echo "Listing workspace after download:"
          ls -la
          echo "Listing downloaded-artifact folder:"
          ls -la download-artifact

       - name: Unzip artifact
         run: |
          sudo apt-get update
          sudo apt-get install -y unzip

          echo "zip files found:"
          ls -la download-artifact/*.zip

          # pick the SHA-based artifact, ignore local.zip if it exists
          ZIP_FILE="$(ls -1 download-artifact/app-build-*.zip | grep -v 'local' | head -n 1)"
          echo "Using ZIP_FILE=${ZIP_FILE}"

          unzip -o "${ZIP_FILE}" -d extracted

          echo "Extracted contents:"
          ls -la extracted

       - name: Deploy simulation
         run: |
          mkdir -p deploy-env/dev
          cp -r extracted/dist deploy-env/dev/
          echo "Deployed files:"
          find deploy-env/dev -type f -maxdepth 3 -print -exec cat {} \;

