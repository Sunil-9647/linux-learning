name: CD - Deploy to DEV

permissions:
  actions: read
  contents: read
  
on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

jobs:
  deploy-dev:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Deploy to DEV
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: Download artifact from triggering CI run
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci.yml
          run_id: ${{ github.event.workflow_run.id }}
          name: build-artifact
          path: artifact
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Show downloaded files
        run: |
          echo "Downloaded artifact contents:"
          ls -la artifact
          
      - name: Detect version from zip
        run: |
          set -e
          ZIP_FILE="$(ls -1 artifact/*.zip | head -n 1)"
          echo "ZIP_FILE=$ZIP_FILE" >> $GITHUB_ENV
          
          # This will become VERSION like: app-v-9c0f9c9
          VERSION="$(basename "$ZIP_FILE" .zip)"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "Detected VERSION: $VERSION"
          echo "VERSION=$VERSION"

      - name: Deploy to DEV using secret path
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip
          
          echo "Deploying zip: $ZIP_FILE"
          unzip -o "$ZIP_FILE" -d extracted

          # versioned deployment directory (very important for rollback)
          mkdir -p "$DEPLOY_PATH/$VERSION"
          cp -r extracted/dist "$DEPLOY_PATH/$VERSION/"
          echo "DEV deployed version: $VERSION (path hidden)"
